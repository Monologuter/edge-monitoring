# 硬件设备对接配置文档

## 系统配置
- **后端服务地址**: `http://47.120.48.64:9000`
- **前端访问地址**: `http://47.120.48.64:3001`
- **文档生成时间**: 2026-01-15

---

## 目录

- [API Key 使用说明](#api-key-使用说明)
- [设备对接配置](#设备对接配置)
  - [1. 道闸设备（车牌识别）](#1-道闸设备车牌识别)
  - [2. 人脸门禁设备](#2-人脸门禁设备)
  - [3. AI边缘盒子](#3-ai边缘盒子)
  - [4. 温湿度传感器](#4-温湿度传感器)
  - [5. 液位传感器](#5-液位传感器)
  - [6. 人员定位系统](#6-人员定位系统)
- [HTTP请求格式](#http请求格式)
- [调试工具](#调试工具)
- [常见问题](#常见问题)

---

## API Key 使用说明

### API Key 的作用

API Key 是硬件设备推送数据到系统时的身份凭证，用于：
1. 验证设备身份，确保只有授权设备可以推送数据
2. 防止未授权设备推送虚假数据
3. 限制每个设备的请求频率（防刷）

### HTTP 请求头中使用

硬件设备推送数据时，需要在 **HTTP 请求头** 中添加 API Key：

```http
POST /api/v1/ingest/person-inout HTTP/1.1
Host: 47.120.48.64:9000
Content-Type: application/json
X-Device-Api-Key: door_entry_001

{
  "idcard": "110101199001011234",
  "personName": "张三",
  "personType": "员工",
  "inOutState": "IN",
  "inOutTime": 1736908800000
}
```

**关键点**：`X-Device-Api-Key: door_entry_001` 就是设备的 API Key

### 使用 curl 命令测试

```bash
# 测试人员出入推送
curl -X POST http://47.120.48.64:9000/api/v1/ingest/person-inout \
  -H "Content-Type: application/json" \
  -H "X-Device-Api-Key: door_entry_001" \
  -d '{
    "idcard": "110101199001011234",
    "personName": "测试人员",
    "personType": "员工",
    "inOutState": "IN",
    "inOutTime": 1736908800000
  }'

# 测试车辆出入推送
curl -X POST http://47.120.48.64:9000/api/v1/ingest/car-inout \
  -H "Content-Type: application/json" \
  -H "X-Device-Api-Key: gate_entry_001" \
  -d '{
    "licensePlateNumber": "京A12345",
    "carType": "小型车",
    "inOutState": "IN",
    "inOutTime": 1736908800000
  }'
```

---

## 设备对接配置

### 1. 道闸设备（车牌识别）

#### 道闸入口（192.168.1.248）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.248 |
| 用户名 | admin |
| 密码 | admin |
| API Key | `gate_entry_001` |
| 推送地址 | `http://47.120.48.64:9000/api/v1/ingest/car-inout` |
| 功能 | 车牌识别、非法入侵报警 |

**推送数据格式**:
```json
{
  "licensePlateNumber": "京A12345",
  "carType": "小型车",
  "inOutState": "IN",
  "inOutTime": 1736908800000
}
```

**字段说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| licensePlateNumber | String | 是 | 车牌号 |
| carType | String | 否 | 车辆类型 |
| inOutState | String | 是 | 进出状态：IN(进场)/OUT(出场) |
| inOutTime | Long | 是 | 时间戳（毫秒） |
| imageFileId | Long | 否 | 抓拍图片文件ID |

#### 道闸出口（192.168.1.249）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.249 |
| 用户名 | admin |
| 密码 | admin |
| API Key | `gate_exit_001` |
| 推送地址 | `http://47.120.48.64:9000/api/v1/ingest/car-inout` |

---

### 2. 人脸门禁设备

#### 人脸识别机入口（192.168.1.246）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.246 |
| 用户名 | admin |
| 密码 | admin |
| API Key | `door_entry_001` |
| 推送地址 | `http://47.120.48.64:9000/api/v1/ingest/person-inout` |
| 功能 | 人脸识别、非法入侵报警 |

**推送数据格式**:
```json
{
  "idcard": "110101199001011234",
  "personName": "张三",
  "personType": "员工",
  "inOutState": "IN",
  "inOutTime": 1736908800000
}
```

**字段说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| idcard | String | 是 | 身份证号 |
| personName | String | 是 | 人员姓名 |
| personType | String | 是 | 人员类型：员工/访客/承包商等 |
| inOutState | String | 是 | 进出状态：IN(进场)/OUT(出场) |
| inOutTime | Long | 是 | 时间戳（毫秒） |
| imageFileId | Long | 否 | 抓拍图片文件ID |

#### 人脸识别机出口（192.168.1.247）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.247 |
| 用户名 | admin |
| 密码 | admin |
| API Key | `door_exit_001` |
| 推送地址 | `http://47.120.48.64:9000/api/v1/ingest/person-inout` |

---

### 3. AI边缘盒子

#### AI盒子（192.168.1.241）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.241 |
| 用户名 | admin |
| 密码 | wy123456 |
| API Key | `ai_box_001` |

**接口地址**:
| 功能 | 地址 | 说明 |
|------|------|------|
| 设备登录 | `POST /device/login` | 获取访问Token |
| 心跳保活 | `POST /device/heartBeat` | 定时发送保持在线 |
| 行为告警 | `POST /device/alarm/action` | 推送行为识别告警 |
| 图片上传 | `POST /device/image` | 上传告警抓拍图片 |
| 视频上传 | `POST /device/video` | 上传告警录像片段 |

**登录请求格式**:
```json
{
  "deviceSerial": "AI_BOX_001",
  "deviceType": "AI_BOX"
}
```

**登录响应格式**:
```json
{
  "code": "200",
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**心跳请求格式**:
```json
{
  "deviceSerial": "AI_BOX_001",
  "timestamp": 1736908800000
}
```

**行为告警推送格式**:
```json
{
  "deviceSerial": "AI_BOX_001",
  "alarmType": "CHANNEL_BLOCKED",
  "alarmTime": 1736908800000,
  "description": "通道堵塞告警",
  "imageBaseUrl": "http://47.120.48.64:9000/box/alarm/20250115/"
}
```

**支持的告警类型**:
| 告警类型 | 说明 |
|----------|------|
| CHANNEL_BLOCKED | 通道堵塞 |
| OVER_HEIGHT | 超高告警 |
| OVER_WEIGHT | 超重告警 |
| OVERCROWDING | 超员告警 |
| CAMERA_OCCLUDED | 摄像头遮挡 |

---

### 4. 温湿度传感器

#### 环境传感器（192.168.1.2）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.2 |
| 用户名 | amx666 |
| 密码 | amx666 |
| API Key | `sensor_env_001` |
| 推送地址 | `http://47.120.48.64:9000/api/v1/ingest/device-reading` |
| 功能 | 环境监测、高低报警 |

**温度推送格式**:
```json
{
  "deviceCode": "temp_001",
  "realValue": 256,
  "systime": 1736908800000
}
```
> 注：温度值需乘以10上报，如25.6℃上报为256

**湿度推送格式**:
```json
{
  "deviceCode": "humid_001",
  "realValue": 650,
  "systime": 1736908800000
}
```
> 注：湿度值需乘以10上报，如65%上报为650

**字段说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| deviceCode | String | 是 | 设备编码，需在系统中预先创建 |
| realValue | Double | 是 | 实时值（温度/湿度×10，液位×1000） |
| systime | Long | 是 | 时间戳（毫秒） |

---

### 5. 液位传感器

#### 液位传感器（192.168.1.2）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.2 |
| API Key | `sensor_env_001` |
| 推送地址 | `http://47.120.48.64:9000/api/v1/ingest/device-reading` |
| 功能 | 液位监测、高低报警 |

**液位推送格式**:
```json
{
  "deviceCode": "level_001",
  "realValue": 1500,
  "systime": 1736908800000
}
```
> 注：液位值需乘以1000上报，如1.5米上报为1500

---

### 6. 人员定位系统

#### 人员定位（192.168.1.20）

| 配置项 | 值 |
|--------|-----|
| 设备IP | 192.168.1.20 |
| API Key | `person_loc_001` |
| 超员告警地址 | `http://47.120.48.64:9000/api/v1/ingest/person-overcrowd` |

**超员告警推送格式**:
```json
{
  "companyCode": "COMPANY001",
  "locationName": "1号库房",
  "actualCount": 15,
  "maxCount": 10,
  "alarmTime": 1736908800000
}
```

---

## HTTP请求格式

### 通用请求头

所有设备推送数据时需要携带以下请求头：

```http
POST /api/v1/ingest/xxx HTTP/1.1
Host: 47.120.48.64:9000
Content-Type: application/json
X-Device-Api-Key: your_api_key_here
```

### 响应格式

**成功响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": null,
  "requestId": "req_123456",
  "timestamp": 1736908800000
}
```

**失败响应**:
```json
{
  "code": 401,
  "message": "设备鉴权失败",
  "data": null,
  "requestId": "req_123456",
  "timestamp": 1736908800000
}
```

### 错误码说明

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| 200 | 成功 | - |
| 400 | 请求参数错误 | 检查请求体格式 |
| 401 | 设备鉴权失败 | 检查API Key是否正确 |
| 403 | IP地址不在白名单 | 检查设备IP是否配置 |
| 429 | 请求频率超限 | 降低推送频率 |
| 500 | 服务器内部错误 | 联系系统管理员 |

---

## 调试工具

### 1. 硬件接入日志页面

**地址**: `http://47.120.48.64:3001/hardware/ingest`

**功能**:
- 查看所有设备推送的数据记录
- 查看请求解析状态（成功/失败）
- 查看原始请求Payload
- 按设备、时间、状态筛选

**筛选条件**:
- 接入通道：HTTP / MQTT
- 消息类型：device-reading / alarm / person-inout / car-inout
- API Key：按设备筛选
- 状态：成功 / 失败

### 2. 设备API密钥管理

**地址**: `http://47.120.48.64:3001/hardware/api-keys`

**功能**:
- 查看所有设备的API Key
- 新增设备API Key
- 编辑设备配置（IP白名单、限流等）
- 删除设备API Key

### 3. 业务数据查看页面

| 页面 | 路径 | 查看内容 |
|------|------|----------|
| 人员出入记录 | `/people` (切换到"出入记录") | 人员进出数据 |
| 车辆出入记录 | `/cars` (切换到"出入记录") | 车辆进出数据 |
| 设备监控 | `/devices/monitor` | 传感器实时数据 |
| 告警中心 | `/alarms` | 告警记录 |
| 数据看板 | `/dashboard` | 综合数据概览 |

---

## 已创建的API密钥列表

| ID | API Key | 允许IP | 用途 |
|----|---------|--------|------|
| 2 | gate_entry_001 | 192.168.1.248 | 道闸入口 |
| 3 | gate_exit_001 | 192.168.1.249 | 道闸出口 |
| 4 | door_entry_001 | 192.168.1.246 | 门禁入口 |
| 5 | door_exit_001 | 192.168.1.247 | 门禁出口 |
| 6 | sensor_env_001 | 192.168.1.2 | 温湿度/液位传感器 |
| 7 | ai_box_001 | 192.168.1.241 | AI盒子 |
| 8 | ai_cam_001 | 192.168.1.201 | AI摄像头 |
| 9 | person_loc_001 | 192.168.1.20 | 人员定位 |

---

## 常见问题

### Q1: 如果硬件设备不支持自定义请求头怎么办？

**A**: 部分设备可能只支持在URL中传递参数。解决方案：
1. 联系硬件厂商确认是否支持自定义HTTP头
2. 使用中间网关进行协议转换
3. 在设备管理界面查找"高级设置"或"自定义参数"

### Q2: API Key 泄露了怎么办？

**A**: 立即执行以下操作：
1. 登录系统，访问"设备API密钥管理"页面
2. 找到泄露的密钥，点击"禁用"或"删除"
3. 重新创建新的API Key
4. 更新硬件设备配置中的API Key

### Q3: 如何查看某个设备推送失败了？

**A**:
1. 访问"硬件接入日志"页面
2. 筛选条件中选择对应的API Key
3. 查看状态为"失败"的记录
4. 点击"详情"查看失败原因

### Q4: 设备推送成功但数据没有显示？

**A**: 检查以下几点：
1. 确认推送的数据格式是否正确（字段名、数据类型）
2. 检查关联的业务数据是否存在（如人员档案、车辆档案）
3. 查看硬件接入日志确认数据已成功解析
4. 刷新业务页面或检查筛选条件

### Q5: 如何测试设备推送功能？

**A**: 使用以下curl命令测试：

```bash
# 测试道闸推送
curl -X POST http://47.120.48.64:9000/api/v1/ingest/car-inout \
  -H "Content-Type: application/json" \
  -H "X-Device-Api-Key: gate_entry_001" \
  -d '{"licensePlateNumber":"京A12345","carType":"小型车","inOutState":"IN","inOutTime":'$(date +%s)000'}'

# 测试门禁推送
curl -X POST http://47.120.48.64:9000/api/v1/ingest/person-inout \
  -H "Content-Type: application/json" \
  -H "X-Device-Api-Key: door_entry_001" \
  -d '{"idcard":"110101199001011234","personName":"测试","personType":"员工","inOutState":"IN","inOutTime":'$(date +%s)000'}'
```

### Q6: 传感器数值的换算规则是什么？

**A**: 不同传感器有不同的换算规则：
- **温度传感器**: 上报值 = 实际温度 × 10（如25.6℃上报256）
- **湿度传感器**: 上报值 = 实际湿度 × 10（如65%上报650）
- **液位传感器**: 上报值 = 实际液位 × 1000（如1.5米上报1500）

这些换算规则可在系统配置文件中修改。

---

## 附录：设备清单汇总

| 设备名称 | IP地址 | 用户名 | 密码 | API Key |
|---------|--------|--------|------|---------|
| 道闸入口 | 192.168.1.248 | admin | admin | gate_entry_001 |
| 道闸出口 | 192.168.1.249 | admin | admin | gate_exit_001 |
| 人脸识别机入口 | 192.168.1.246 | admin | admin | door_entry_001 |
| 人脸识别机出口 | 192.168.1.247 | admin | admin | door_exit_001 |
| 温湿度传感器 | 192.168.1.2 | amx666 | amx666 | sensor_env_001 |
| 液位传感器 | 192.168.1.2 | - | - | sensor_env_001 |
| 400万AI摄像头 | 192.168.1.201-208 | admin | a1234567 | ai_cam_001 |
| 800万像素摄像头 | 192.168.1.209-210 | admin | a1234567 | ai_cam_001 |
| IP音柱（广播） | 192.168.1.191 | - | - | - |
| 人员定位 | 192.168.1.20 | - | - | person_loc_001 |
| AI盒子 | 192.168.1.241 | admin | wy123456 | ai_box_001 |

---

## 联系支持

如有任何问题，请联系系统管理员或查看以下资源：
- 系统前端：http://47.120.48.64:3001
- 硬件接入日志：http://47.120.48.64:3001/hardware/ingest
- 设备API密钥管理：http://47.120.48.64:3001/hardware/api-keys

---

*文档版本: 1.0*
*最后更新: 2026-01-15*
